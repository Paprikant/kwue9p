#!/bin/bash

function follow {
    echo "Installing files"
    [ -f /usr/bin/consul ] && rm /usr/bin/consul
    cp -a bin/consul /usr/bin/consul
    cp -a configs/consul.service /etc/systemd/system/
    cp -a configs/consul-env /etc/consul-env
}

function first {
    echo "Installing files"
    [ -f /usr/bin/consul ] && rm /usr/bin/consul
    cp -a bin/consul /usr/bin/consul
    cp -a configs/consul-first.service /etc/systemd/system/
    cp -a configs/consul-env /etc/consul-env
}

function makeenv {
    ip=$(/sbin/ifconfig eth0 | grep 'inet addr:' | cut -d: -f2 | awk '{ print $1}')
    name=$(hostname)
    if [ "$1" = "follow" ]; then
        echo "provide a node address of an existing cluster below"
        read node
	printf "HOST_NAME=$name \nHOST_IP=$ip \nJOIN_NODE=$node" > configs/consul-env
    else 
        echo "Generating configs/consul-env"
        printf "HOST_NAME=$name \nHOST_IP=$ip" > configs/consul-env 
    fi
}

case $1 in 
    follow)
	makeenv $1
        follow
        ;;
    first)
        makeenv
        first
        ;;
    *)
        echo 'Specify "follow" or "first" as $1'
        ;;
esac

